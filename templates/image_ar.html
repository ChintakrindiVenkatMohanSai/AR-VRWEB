<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image AR â€“ {{ project.name }}</title>
    <style>
        body { margin:0; overflow:hidden; background:#000; font-family:system-ui; }
        video { position:fixed; inset:0; width:100vw; height:100vh; object-fit:cover; }
        #ar-plate {
            position:fixed;
            top:50%; left:50%;
            width:320px;
            transform:translate(-50%,-50%);
            border-radius:16px;
            box-shadow: 0 30px 100px #000c, inset 0 0 20px #fff2;
            cursor:grab;
            user-select:none;
            touch-action:none;
        }
        #ar-plate img { width:100%; border-radius:16px; display:block; }
        .capture-btn {
            position:fixed; bottom:30px; left:50%;
            transform:translateX(-50%);
            padding:14px 36px;
            background:rgba(0,188,212,0.9);
            border:none; border-radius:50px;
            color:white; font-weight:bold; font-size:1.1rem;
            backdrop-filter:blur(10px);
            box-shadow:0 8px 30px #0008;
        }
    </style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>

<div id="ar-plate">
    <img src="{{ project.file_url }}" alt="{{ project.name }}">
</div>

<button class="capture-btn" onclick="capture()">ðŸ“¸ Capture</button>

<script>
    // Camera
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => document.getElementById("video").srcObject = stream)
        .catch(err => alert("Camera access denied\n\n" + err));

    // Simple drag + zoom (touch/mouse)
    let plate = document.getElementById("ar-plate");
    let x = 0, y = 0, scale = 1, rot = 0;
    let startX, startY, startScale, startRot;

    function updateTransform() {
        plate.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px) scale(${scale}) rotate(${rot}deg)`;
    }

    // Mouse
    plate.onpointerdown = e => {
        startX = e.clientX - x;
        startY = e.clientY - y;
        plate.setPointerCapture(e.pointerId);

        let move = e => {
            x = e.clientX - startX;
            y = e.clientY - startY;
            updateTransform();
        };

        let up = () => {
            document.removeEventListener("pointermove", move);
            document.removeEventListener("pointerup", up);
        };

        document.addEventListener("pointermove", move);
        document.addEventListener("pointerup", up);
    };

    // Wheel zoom
    plate.onwheel = e => {
        e.preventDefault();
        scale += e.deltaY * -0.001;
        scale = Math.max(0.4, Math.min(3, scale));
        updateTransform();
    };

    // Capture screenshot
    function capture() {
        html2canvas(document.body, {backgroundColor: null}).then(canvas => {
            let a = document.createElement('a');
            a.href = canvas.toDataURL("image/png");
            a.download = `AR_${Date.now()}.png`;
            a.click();
        });
    }
</script>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

</body>
</html>
<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AR Image Viewer</title>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>

body{
margin:0;
overflow:hidden;
background:black;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
perspective:2000px;
}

/* Camera */
video{
position:fixed;
top:0;
left:0;
width:100vw;
height:100vh;
object-fit:cover;
z-index:0;
filter:brightness(.95);
}

/* AR image */
.arImage{
position:fixed;
top:50%;
left:50%;
width:320px;
border-radius:25px;
cursor:grab;
touch-action:none;
transform-style:preserve-3d;
z-index:2;

box-shadow:
0 100px 200px rgba(0,0,0,.9),
0 20px 60px rgba(0,0,0,.6);
}

.arImage img{
width:100%;
border-radius:25px;
}

/* Capture button only */
.captureBtn{
position:fixed;
bottom:40px;
left:50%;
transform:translateX(-50%);
background:linear-gradient(135deg,#00e5ff,#7c3aed);
padding:16px 55px;
border-radius:60px;
color:white;
border:none;
font-weight:600;
z-index:5;
cursor:pointer;
box-shadow:0 10px 40px rgba(0,255,255,.4);
}

.captureBtn:hover{
transform:translateX(-50%) scale(1.05);
}

</style>
</head>

<body>

<!-- Camera -->
<video id="cam" autoplay playsinline muted></video>

<!-- AR Image -->
<div class="arImage" id="plate">
<img src="{{ project.file_url }}">
</div>

<!-- ONLY BUTTON -->
<button class="captureBtn" onclick="captureAR()">
ðŸ“¸ Capture
</button>

<script>

/* CAMERA */
navigator.mediaDevices.getUserMedia({
video:{ facingMode:"environment" }
}).then(stream=>{
cam.srcObject=stream;
}).catch(()=>{
alert("Camera requires HTTPS. Use deployed site on mobile.");
});

/* TRANSFORM VARIABLES */
let plate=document.getElementById("plate");
let x=0,y=0,scale=1,rotation=0;
let startX,startY,startDist,startAngle;

function update(){
plate.style.transform=`
translate(calc(-50% + ${x}px), calc(-50% + ${y}px))
scale(${scale})
rotate(${rotation}deg)
`;
}

/* Mouse drag */
plate.onmousedown=e=>{
startX=e.clientX-x;
startY=e.clientY-y;

document.onmousemove=e=>{
x=e.clientX-startX;
y=e.clientY-startY;
update();
};

document.onmouseup=()=>document.onmousemove=null;
};

/* Zoom */
plate.onwheel=e=>{
e.preventDefault();
scale+=e.deltaY*-0.001;
scale=Math.max(.3,Math.min(scale,3));
update();
};

/* Touch gestures */
plate.addEventListener("touchstart",e=>{
if(e.touches.length==1){
startX=e.touches[0].clientX-x;
startY=e.touches[0].clientY-y;
}
if(e.touches.length==2){
startDist=getDist(e);
startAngle=getAngle(e);
}
});

plate.addEventListener("touchmove",e=>{
e.preventDefault();

if(e.touches.length==1){
x=e.touches[0].clientX-startX;
y=e.touches[0].clientY-startY;
}

if(e.touches.length==2){
let d=getDist(e);
scale*=d/startDist;
startDist=d;

let a=getAngle(e);
rotation+=a-startAngle;
startAngle=a;
}

update();
});

/* Helpers */
function getDist(e){
let dx=e.touches[0].clientX-e.touches[1].clientX;
let dy=e.touches[0].clientY-e.touches[1].clientY;
return Math.sqrt(dx*dx+dy*dy);
}

function getAngle(e){
let dx=e.touches[1].clientX-e.touches[0].clientX;
let dy=e.touches[1].clientY-e.touches[0].clientY;
return Math.atan2(dy,dx)*180/Math.PI;
}

/* Capture */
function captureAR(){
html2canvas(document.body).then(canvas=>{
let link=document.createElement("a");
link.download="AR_Image.png";
link.href=canvas.toDataURL();
link.click();
});
}

</script>

</body>
</html>